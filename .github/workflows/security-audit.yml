name: Security Audit

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: |
        npm audit --audit-level=moderate
        echo "NPM audit completed"
    
    - name: Check for outdated dependencies
      run: |
        npm outdated || true
        echo "Dependency check completed"
    
    - name: Run security audit script
      run: node scripts/security-audit.js || true
      env:
        NODE_ENV: test
    
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: |
          logs/security.log
          npm-audit.json
        retention-days: 30
    
    - name: Create issue on vulnerability
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const title = `Security Vulnerability Detected - ${new Date().toISOString().split('T')[0]}`;
          const body = `A security vulnerability was detected during the automated audit.
          
          Please review the security audit artifacts and take appropriate action.
          
          - Check the Actions tab for detailed logs
          - Review the uploaded security report
          - Run \`npm audit fix\` to attempt automatic fixes
          
          This issue was automatically created by the security audit workflow.`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['security', 'automated']
          });

  dependency-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Update dependencies
      run: |
        npm update
        npm audit fix
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        commit-message: 'chore: update dependencies and fix vulnerabilities'
        title: '[Automated] Update Dependencies and Fix Vulnerabilities'
        body: |
          This PR was automatically created to update dependencies and fix security vulnerabilities.
          
          - Updated npm dependencies
          - Applied npm audit fixes
          
          Please review the changes before merging.
        branch: automated-dependency-updates
        delete-branch: true